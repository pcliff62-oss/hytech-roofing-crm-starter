generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Tenant {
  id                   String                @id @default(cuid())
  name                 String
  // Company info fields
  phone                String? // Company primary phone
  email                String? // Company contact email
  address1             String? // Street address line 1
  address2             String? // Street address line 2
  city                 String? // City
  state                String? // State / Province
  postal               String? // Postal / ZIP code
  logoPath             String? // Uploaded logo file path
  licensesJson         String? // JSON array of { type, number, expires }
  createdAt            DateTime              @default(now())
  appointments         Appointment[]
  contacts             Contact[]
  droneMissions        DroneMission[]
  files                File[]
  leads                Lead[]
  measurements         Measurement[]
  measurementVersions  MeasurementVersion[]
  processingJobs       ProcessingJob[]
  properties           Property[]
  proposals            Proposal[]
  solarInsights        SolarInsight[]
  users                User[]
  pastJobs             PastJob[]
  appointmentAssignees AppointmentAssignee[]
  appointmentCrews     AppointmentCrew[]
  jobScopes            JobScope[]
}

model User {
  id                   String                @id @default(cuid())
  email                String                @unique
  name                 String
  role                 Role                  @default(EMPLOYEE)
  tenantId             String
  createdAt            DateTime              @default(now())
  /// Sales commission percent (e.g., 5 for 5%)
  commissionPercent    Float?
  /// Sales base pay amount applied per selected period
  basePayAmount        Float?
  /// Period that base pay applies to (JOB | WEEK | MONTH)
  basePayPeriod        BasePayPeriod?
  appointments         Appointment[]
  assignedLeads        Lead[]                @relation("LeadAssignee")
  tenant               Tenant                @relation(fields: [tenantId], references: [id])
  appointmentAssignees AppointmentAssignee[]
}

enum Role {
  ADMIN
  SALES
  CREW
  EMPLOYEE
}

enum BasePayPeriod {
  JOB
  WEEK
  MONTH
}

model Property {
  id            String         @id @default(cuid())
  tenantId      String
  contactId     String?
  address1      String
  address2      String?
  city          String
  state         String
  postal        String
  lat           Float?
  lng           Float?
  createdAt     DateTime       @default(now())
  droneMissions DroneMission[]
  leads         Lead[]         @relation("PropertyLeads")
  measurements  Measurement[]  @relation("PropertyMeasurements")
  contact       Contact?       @relation("ContactProperties", fields: [contactId], references: [id])
  tenant        Tenant         @relation(fields: [tenantId], references: [id])
  solarInsights SolarInsight[]
}

model Lead {
  id            String         @id @default(cuid())
  tenantId      String
  contactId     String?
  propertyId    String?
  title         String
  stage         String         @default("LEAD")
  source        String?
  estimator     String?
  probability   Int?
  assigneeId    String?
  category      String?
  customScope   String?
  notes         String?
  contractPrice Float?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  appointments  Appointment[]  @relation("LeadAppointments")
  droneMissions DroneMission[]
  files         File[]
  assignee      User?          @relation("LeadAssignee", fields: [assigneeId], references: [id])
  property      Property?      @relation("PropertyLeads", fields: [propertyId], references: [id])
  contact       Contact?       @relation("ContactLeads", fields: [contactId], references: [id])
  tenant        Tenant         @relation(fields: [tenantId], references: [id])
  measurements  Measurement[]  @relation("LeadMeasurements")
  proposals     Proposal[]     @relation("LeadProposals")
  solarInsights SolarInsight[]
  pastJobs      PastJob[]
}

model Measurement {
  id               String               @id @default(cuid())
  tenantId         String
  leadId           String?
  propertyId       String?
  geojson          String
  totalSquares     Float?
  totalPerimeterFt Float?
  wasteFactor      Float?
  notes            String?
  createdAt        DateTime             @default(now())
  gsdMPerPx        Float?
  sourceImagePath  String?
  property         Property?            @relation("PropertyMeasurements", fields: [propertyId], references: [id])
  lead             Lead?                @relation("LeadMeasurements", fields: [leadId], references: [id])
  tenant           Tenant               @relation(fields: [tenantId], references: [id])
  versions         MeasurementVersion[]
}

model SolarInsight {
  id           String    @id @default(cuid())
  tenantId     String
  propertyId   String?
  leadId       String?
  quality      String
  fetchedAt    DateTime  @default(now())
  totalM2      Float?
  totalSquares Float?
  segmentsJson String
  rawJson      String
  lead         Lead?     @relation(fields: [leadId], references: [id])
  property     Property? @relation(fields: [propertyId], references: [id])
  tenant       Tenant    @relation(fields: [tenantId], references: [id])
}

model Proposal {
  id               String         @id @default(cuid())
  tenantId         String
  leadId           String?
  templateName     String
  templateBody     String
  mergedHtml       String?
  status           String         @default("Draft")
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  grandTotal       Float?
  publicId         String?        @unique
  signToken        String?        @unique
  signTokenExpires DateTime?
  signatureDataUrl String?
  signedAt         DateTime?
  signerEmail      String?
  signerName       String?
  snapshotJson     String?
  lead             Lead?          @relation("LeadProposals", fields: [leadId], references: [id])
  tenant           Tenant         @relation(fields: [tenantId], references: [id])
  ProposalView     ProposalView[]
}

model Contact {
  id            String         @id @default(cuid())
  tenantId      String
  name          String
  email         String?
  phone         String?
  organization  String?
  flagColor     String? // 'red' | 'yellow' | 'green'
  createdAt     DateTime       @default(now())
  tenant        Tenant         @relation(fields: [tenantId], references: [id])
  droneMissions DroneMission[]
  files         File[]
  leads         Lead[]         @relation("ContactLeads")
  properties    Property[]     @relation("ContactProperties")
}

model File {
  id        String        @id @default(cuid())
  tenantId  String
  contactId String?
  leadId    String?
  missionId String?
  category  String
  folder    String
  name      String
  path      String
  mime      String?
  size      Int?
  createdAt DateTime      @default(now())
  mission   DroneMission? @relation(fields: [missionId], references: [id])
  lead      Lead?         @relation(fields: [leadId], references: [id])
  contact   Contact?      @relation(fields: [contactId], references: [id])
  tenant    Tenant        @relation(fields: [tenantId], references: [id])
}

/// Editor snapshots for measurements to support load/save versions
model MeasurementVersion {
  id            String      @id @default(cuid())
  tenantId      String
  measurementId String
  name          String?
  payloadJson   String
  createdAt     DateTime    @default(now())
  measurement   Measurement @relation(fields: [measurementId], references: [id])
  tenant        Tenant      @relation(fields: [tenantId], references: [id])

  @@index([tenantId, measurementId, createdAt])
}

model Appointment {
  id              String                @id @default(cuid())
  tenantId        String
  title           String
  description     String?
  start           DateTime
  end             DateTime
  allDay          Boolean               @default(false)
  leadId          String?
  userId          String?
  // Job enhancement fields
  crewId          String? // Assigned crew id
  jobStatus       String?               @default("scheduled") // scheduled | in_progress | submitted | approved | completed
  materialOrdered Boolean?              @default(false)
  squares         Float? // Cached squares for duration/invoice
  extrasJson      String? // JSON array of extras line items
  attachmentsJson String? // JSON array of attachment refs
  completedAt     DateTime? // When job card marked complete (crew submission)
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt
  user            User?                 @relation(fields: [userId], references: [id])
  lead            Lead?                 @relation("LeadAppointments", fields: [leadId], references: [id])
  tenant          Tenant                @relation(fields: [tenantId], references: [id])
  // New relations
  assignees       AppointmentAssignee[]
  crews           AppointmentCrew[]
  scopes          JobScope[]
}

/// Planned drone scanning mission for a property (flight path metadata only â€“ actual drone execution handled externally)
model DroneMission {
  id             String             @id @default(cuid())
  tenantId       String
  leadId         String?
  propertyId     String?
  contactId      String?
  title          String
  status         String             @default("PLANNED")
  altitudeFt     Int?
  frontOverlap   Int?
  sideOverlap    Int?
  captureMode    String?
  pitchDeg       Int?
  pathGeoJson    String
  photoCountEst  Int?
  notes          String?
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  contact        Contact?           @relation(fields: [contactId], references: [id])
  property       Property?          @relation(fields: [propertyId], references: [id])
  lead           Lead?              @relation(fields: [leadId], references: [id])
  tenant         Tenant             @relation(fields: [tenantId], references: [id])
  waypoints      DroneWaypoint[]
  photos         File[]
  events         MissionEvent[]
  telemetry      MissionTelemetry[]
  processingJobs ProcessingJob[]
}

model DroneWaypoint {
  id          String       @id @default(cuid())
  missionId   String
  order       Int
  lat         Float
  lng         Float
  altitudeFt  Int?
  action      String?
  gimbalPitch Float?
  gimbalYaw   Float?
  createdAt   DateTime     @default(now())
  mission     DroneMission @relation(fields: [missionId], references: [id])

  @@index([missionId, order])
}

/// Generic processing job (e.g. photogrammetry stitching) placeholder
model ProcessingJob {
  id            String        @id @default(cuid())
  tenantId      String
  missionId     String?
  provider      String
  status        String        @default("QUEUED")
  inputJson     String
  outputJson    String?
  errorMsg      String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  providerJobId String?
  mission       DroneMission? @relation(fields: [missionId], references: [id])
  tenant        Tenant        @relation(fields: [tenantId], references: [id])

  @@index([tenantId, missionId])
}

/// Individual telemetry points (optionally batched via API) for a mission
model MissionTelemetry {
  id          String       @id @default(cuid())
  missionId   String
  ts          DateTime     @default(now())
  lat         Float
  lng         Float
  altAGL      Float?
  altMSL      Float?
  heading     Float?
  gimbalPitch Float?
  speedMS     Float?
  batteryPct  Int?
  mission     DroneMission @relation(fields: [missionId], references: [id])

  @@index([missionId, ts])
}

/// Discrete mission lifecycle or error events
model MissionEvent {
  id        String       @id @default(cuid())
  missionId String
  ts        DateTime     @default(now())
  type      String
  meta      String?
  mission   DroneMission @relation(fields: [missionId], references: [id])

  @@index([missionId, ts])
  @@index([missionId, type])
}

model ProposalView {
  id         String   @id
  proposalId String
  viewedAt   DateTime @default(now())
  ipAddress  String?
  userAgent  String?
  Proposal   Proposal @relation(fields: [proposalId], references: [id], onDelete: Cascade)

  @@index([proposalId, viewedAt])
}

/// Historical completed jobs for payroll/analytics
model PastJob {
  id            String   @id @default(cuid())
  tenantId      String
  leadId        String?
  appointmentId String?
  crewUserId    String?
  customerName  String?
  address       String?
  squares       Float?
  extrasJson    String? // JSON array of { title, price }
  usedSquares   Float?
  rateTier      String? // easy | medium | difficult
  ratePerSquare Float?
  installTotal  Float? // usedSquares * ratePerSquare
  extrasTotal   Float?
  grandTotal    Float?
  completedAt   DateTime @default(now())
  createdAt     DateTime @default(now())
  tenant        Tenant   @relation(fields: [tenantId], references: [id])
  lead          Lead?    @relation(fields: [leadId], references: [id])

  @@index([tenantId, completedAt])
  @@index([leadId])
  @@index([crewUserId])
}

/// Many-to-many assignment of users to appointments (sales, crew, etc.)
model AppointmentAssignee {
  id            String      @id @default(cuid())
  tenantId      String
  appointmentId String
  userId        String
  role          Role?
  createdAt     DateTime    @default(now())
  appointment   Appointment @relation(fields: [appointmentId], references: [id])
  user          User        @relation(fields: [userId], references: [id])
  tenant        Tenant      @relation(fields: [tenantId], references: [id])

  @@index([tenantId, appointmentId])
  @@index([tenantId, userId])
}

/// Many-to-many appointment to crews (string id to support external crew registry)
model AppointmentCrew {
  id            String      @id @default(cuid())
  tenantId      String
  appointmentId String
  crewId        String
  scopeId       String?
  createdAt     DateTime    @default(now())
  appointment   Appointment @relation(fields: [appointmentId], references: [id])
  tenant        Tenant      @relation(fields: [tenantId], references: [id])

  @@index([tenantId, appointmentId])
  @@index([tenantId, crewId])
}

/// Parsed scopes of work for a job (from signed proposal title)
model JobScope {
  id             String      @id @default(cuid())
  tenantId       String
  appointmentId  String
  category       String
  title          String?
  assignedCrewId String?
  createdAt      DateTime    @default(now())
  appointment    Appointment @relation(fields: [appointmentId], references: [id])
  tenant         Tenant      @relation(fields: [tenantId], references: [id])

  @@index([tenantId, appointmentId])
}
